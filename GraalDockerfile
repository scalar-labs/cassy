FROM oracle/graalvm-ce:19.2.0 AS builder
WORKDIR /opt/graalvm
RUN gu install native-image

RUN mkdir -p /opt/cassy
WORKDIR /opt/cassy

COPY gradle ./gradle
COPY build.gradle ./
COPY gradlew ./gradlew
COPY src ./src

RUN ./gradlew installDist
#RUN ./gradlew nativeImage -Ptype=server
RUN cd build/install/cassy/ && native-image --no-server -cp ".:lib/*" -H:Name=cassy_natimg -H:Path=bin/ com.scalar.cassy.server.CassyServer

FROM oracle/openjdk:8

RUN yum install sqlite

WORKDIR /opt/cassy

RUN mkdir -p /cassy/data && mkdir -p /cassy/conf

COPY --from=builder /opt/cassy/build ./build
COPY scripts ./scripts
COPY conf ./conf
COPY .aws ./.aws

ENV AWS_CONFIG_FILE=./.aws/config
RUN sqlite3 ./cassy.db < ./scripts/db.schema

VOLUME /cassy

ENTRYPOINT ["/bin/sh", "scripts/entrypoint-graal.sh"]
CMD ["--config", "/cassy/conf/cassy.properties"]

EXPOSE 20051
